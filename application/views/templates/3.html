<div class="middle" style="height:150px;">
    <h2 class="spanMiddle">Please look into the camera and press "Ready"</h2>
</div>

<div class="middle" style="height:10px;">
    <p>Request for access to your camera will appear. Click to allow.</p>
</div>

<div class="middle" style="height:300px;">
    <div style="width: 800px; margin: auto;">
        <div class="spanMiddle" style="display: block; margin: 0 auto;">
                <video id="your-video-id" controls="" autoplay=""></video>
                <h2 id="header"></h2>
        </div>
    </div>
    <div style="width: 300px; margin: auto auto 30px;">
        <div class="spanMiddle" style="display: block; margin: 0 auto;">
            <button id="btn-start-recording" class="btn btn-block">Ready</button>
        </div>
    </div>
</div>

<script type="text/javascript">
    $("#btn-start-recording").click(function() {
        $("#btn-start-recording").hide();
        
        // capture camera and/or microphone
        navigator.mediaDevices.getUserMedia({ video: true, audio: false }).then(function(camera) {

            // preview camera during recording
            document.getElementById('your-video-id').muted = true;
            document.getElementById('your-video-id').srcObject = camera;

            // recording configuration/hints/parameters
            var recordingHints = {
                type: 'video'
            };

            // initiating the recorder
            var recorder = RecordRTC(camera, recordingHints);

            // starting recording here
            recorder.startRecording();

            // auto stop recording after 10 seconds
            var milliSeconds = 10000;
            setTimeout(function() {

                // stop recording
                recorder.stopRecording(function() {

                    // get recorded blob
                    var blob = recorder.getBlob();

                    // generating a random file name
                    var fileName = getFileName('webm');

                    // we need to upload "File" --- not "Blob"
                    var fileObject = new File([blob], fileName, {
                        type: 'video/webm'
                    });

                    var formData = new FormData();

                    // recorded data
                    formData.append('video-blob', fileObject);

                    // file name
                    formData.append('video-filename', fileObject.name);

                    // upload using jQuery
                    $.ajax({
                        url: '/upload-video', 
                        data: formData,
                        cache: false,
                        contentType: false,
                        processData: false,
                        type: 'POST',
                        success: function(response) {
                            if (response === 'success') {
                                // alert('successfully uploaded recorded blob');

                                // file path on server
                                // var fileDownloadURL = '/video/' + fileObject.name;

                                // preview uploaded file in a VIDEO element
                                // document.getElementById('your-video-id').src = fileDownloadURL;

                                location.href = '/4';
                            } else {
                                alert(response); // error/failure
                            }
                        }
                    });

                    // release camera
                    document.getElementById('your-video-id').srcObject = null;
                    camera.getTracks().forEach(function(track) {
                        track.stop();
                    });

                });

            }, milliSeconds);
        });
    });

    // this function is used to generate random file name
    function getFileName(fileExtension) {
        var d = new Date();
        var year = d.getUTCFullYear();
        var month = d.getUTCMonth();
        var date = d.getUTCDate();
        return 'RecordRTC-' + year + month + date + '-' + getRandomString() + '.' + fileExtension;
    }

    function getRandomString() {
        if (window.crypto && window.crypto.getRandomValues && navigator.userAgent.indexOf('Safari') === -1) {
            var a = window.crypto.getRandomValues(new Uint32Array(3)),
                token = '';
            for (var i = 0, l = a.length; i < l; i++) {
                token += a[i].toString(36);
            }
            return token;
        } else {
            return (Math.random() * new Date().getTime()).toString(36).replace(/\./g, '');
        }
    }
</script>